---
import Layout from '../../layouts/Layout.astro';
import Hero from '../../components/Hero.astro';
import Countdown from '../../components/Countdown.astro';
import CoupleDetails from '../../components/CoupleDetails.astro';
import EventsTimeline from '../../components/EventsTimeline.astro';
import Venue from '../../components/Venue.astro';
import Gallery from '../../components/Gallery.astro';
import MessageBoard from '../../components/MessageBoard.astro';
import Registry from '../../components/Registry.astro';
import RSVP from '../../components/RSVP.astro';
import { getGuestByCode } from '../../lib/supabase';
import { config } from '../../config';

export const prerender = false;

const { code } = Astro.params;

// Fetch guest data
let guest = null;
let error = null;

if (code) {
  try {
    guest = await getGuestByCode(code);
    if (!guest) {
      error = 'Invalid invitation link';
    }
  } catch (e) {
    console.error('Error fetching guest:', e);
    error = 'Failed to load invitation';
  }
}

// Page title with guest name if available
const pageTitle = guest
  ? `${guest.name} - ${config.couple.person1.name} & ${config.couple.person2.name}'s Wedding`
  : config.site.title;
---

<Layout title={pageTitle} bodyClass={guest ? 'has-welcome-banner' : ''}>
  <main>
    {error ? (
      <section class="min-h-screen flex items-center justify-center bg-secondary">
        <div class="text-center px-6">
          <h1 class="font-serif text-4xl mb-4">Oops!</h1>
          <p class="text-muted mb-6">{error}</p>
          <a href="/" class="btn btn-primary">Go to Homepage</a>
        </div>
      </section>
    ) : (
      <>
        {/* Welcome message for guest - fixed below nav */}
        <div class="welcome-banner">
          <span class="opacity-90">Welcome,</span>{' '}
          <span class="font-medium">{guest?.name}</span>!{' '}
          <span class="opacity-90">You're invited to celebrate with us.</span>
        </div>
        {/* Spacer to account for fixed welcome banner */}
        <div class="welcome-banner-spacer"></div>

        <Hero />
        <Countdown />
        <CoupleDetails />
        <EventsTimeline />
        <Venue />
        <Gallery />
        <MessageBoard guestCode={code} guestName={guest?.name} />
        <Registry />
        <RSVP
          guestCode={code}
          guestName={guest?.name}
          guestEmail={guest?.email}
          invitedTo={guest?.invited_to}
          maxPlusOnes={guest?.max_plus_ones || 0}
          existingRsvpStatus={guest?.rsvp_status}
          existingAttendingCount={guest?.attending_count || 0}
          existingDietaryNotes={guest?.dietary_notes}
          existingSongRequest={guest?.song_request}
          existingAttendingEvents={guest?.attending_events || []}
        />
      </>
    )}
  </main>
</Layout>
